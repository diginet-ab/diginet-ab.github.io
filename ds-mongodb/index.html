<!doctype html>
<html class="default no-js">
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>@diginet/ds-mongodb</title>
	<meta name="description" content="">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="stylesheet" href="assets/css/main.css">
</head>
<body>
<header>
	<div class="tsd-page-toolbar">
		<div class="container">
			<div class="table-wrap">
				<div class="table-cell" id="tsd-search" data-index="assets/js/search.js" data-base=".">
					<div class="field">
						<label for="tsd-search-field" class="tsd-widget search no-caption">Search</label>
						<input id="tsd-search-field" type="text" />
					</div>
					<ul class="results">
						<li class="state loading">Preparing search index...</li>
						<li class="state failure">The search index is not available</li>
					</ul>
					<a href="index.html" class="title">@diginet/ds-mongodb</a>
				</div>
				<div class="table-cell" id="tsd-widgets">
					<div id="tsd-filter">
						<a href="#" class="tsd-widget options no-caption" data-toggle="options">Options</a>
						<div class="tsd-filter-group">
							<div class="tsd-select" id="tsd-filter-visibility">
								<span class="tsd-select-label">All</span>
								<ul class="tsd-select-list">
									<li data-value="public">Public</li>
									<li data-value="protected">Public/Protected</li>
									<li data-value="private" class="selected">All</li>
								</ul>
							</div>
							<input type="checkbox" id="tsd-filter-inherited" checked />
							<label class="tsd-widget" for="tsd-filter-inherited">Inherited</label>
							<input type="checkbox" id="tsd-filter-externals" checked />
							<label class="tsd-widget" for="tsd-filter-externals">Externals</label>
							<input type="checkbox" id="tsd-filter-only-exported" />
							<label class="tsd-widget" for="tsd-filter-only-exported">Only exported</label>
						</div>
					</div>
					<a href="#" class="tsd-widget menu no-caption" data-toggle="menu">Menu</a>
				</div>
			</div>
		</div>
	</div>
	<div class="tsd-page-title">
		<div class="container">
			<ul class="tsd-breadcrumb">
				<li>
					<a href="globals.html">Globals</a>
				</li>
			</ul>
			<h1> @diginet/ds-mongodb</h1>
		</div>
	</div>
</header>
<div class="container container-main">
	<div class="row">
		<div class="col-8 col-content">
			<div class="tsd-panel tsd-typography">
				<h1 id="distributed-system-mongodb">Distributed System MongoDB</h1>
				<p>Utility classes for accessing MongoDb databases and GridFS file systems embedded in MongoDB databases.</p>
				<h2 id="use-in-browser">Use in browser</h2>
				<p>ds-mongodb can be used in NodeJS as well as browsers apps. The GridFS related file operations are partially available for web applications using data as string or Buffer. NodeJS applications can use disk file operations as well.</p>
				<h2 id="file-system-gridfs-for-nodejs-and-browsers">File system GridFS for NodeJS and browsers</h2>
				<p>GridFS files can be accessed with standard NodeJS fs operations by using the npm package <a href="https://github.com/diginet-ab/BrowserFS">@diginet/BrowserFS</a>. The BrowserFS package can store and access entire file systems in a number of different storage types such as browser local storage and also GridFS. The storage type GridFsFileSystem uses ds-mongodb to store an entire file system in a GridFS database. MountableFileSystem can be used to access multiple file systems in a single directory hierarchy. AsyncMirror can be used with MountableFileSystem to map a synchronous file system to an asynchronous file system such as GridFsFileSystem. The files loaded from the async fs to the local sync fs can be filtered to include or exclude certain files and file types, see AsyncMirror options. @diginet/BrowserFS is a fork based on <a href="https://github.com/jvilk/BrowserFS">https://github.com/jvilk/BrowserFS</a>.</p>
				<h2 id="example-usage">Example usage</h2>
				<h3 id="database-operations">Database operations</h3>
				<pre><code class="lang-typescript"><span class="hljs-keyword">import</span> { MongoDb } <span class="hljs-keyword">from</span> <span class="hljs-string">"ds-mongodb"</span>

<span class="hljs-keyword">let</span> mongoDb = <span class="hljs-keyword">new</span> MongoDb();
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">foo</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">let</span> db = <span class="hljs-keyword">await</span> mongoDb.openDatabase(<span class="hljs-string">"myDb"</span>)
        <span class="hljs-keyword">let</span> c = <span class="hljs-string">"myCollection"</span>
        <span class="hljs-keyword">let</span> id = <span class="hljs-keyword">await</span> mongoDb.insertDocument(db, c, { hello: <span class="hljs-string">"world"</span> })
        <span class="hljs-keyword">let</span> o = <span class="hljs-keyword">await</span> mongoDb.getDocument(db, c, { _id: id })
        <span class="hljs-keyword">let</span> n = <span class="hljs-keyword">await</span> mongoDb.documentCount(db, c)
        n = <span class="hljs-keyword">await</span> mongoDb.documentCount(db, c, { hello: <span class="hljs-string">"world"</span> })
        <span class="hljs-keyword">let</span> result = <span class="hljs-keyword">await</span> mongoDb.updateDocument(db, c, { _id: id }, { $<span class="hljs-keyword">set</span>: { pi: <span class="hljs-number">3.14</span> }})
        result = <span class="hljs-keyword">await</span> mongoDb.deleteDocument(db, c, { _id: id })
        n = <span class="hljs-keyword">await</span> mongoDb.deleteDocuments(db, c, { hello: <span class="hljs-string">"world"</span> })
        <span class="hljs-keyword">await</span> mongoDb.closeDatabase(db)
    } <span class="hljs-keyword">catch</span> (e) {
        <span class="hljs-built_in">console</span>.log(e)
    }
}

foo()
</code></pre>
				<h2 id="gridfs-string-operations">GridFS string operations</h2>
				<p>The GridFS file storage functionality of the MongoDB database system can be accessed from both NodeJS and browser apps using string and Buffer.</p>
				<h4 id="example">Example</h4>
				<pre><code class="lang-typescript"><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> assert <span class="hljs-keyword">from</span> <span class="hljs-string">"assert"</span>
<span class="hljs-keyword">import</span> { GridFs } <span class="hljs-keyword">from</span> <span class="hljs-string">"../../src/GridFs"</span>

<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">test</span>(<span class="hljs-params"></span>) </span>{

    <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">let</span> grid = <span class="hljs-keyword">new</span> GridFs()
        <span class="hljs-keyword">await</span> grid.open(<span class="hljs-string">"f"</span>)
        <span class="hljs-keyword">await</span> grid.clear()

        <span class="hljs-comment">// Upload and download string</span>
        <span class="hljs-keyword">await</span> grid.uploadString(<span class="hljs-string">"MyFile.txt"</span>, <span class="hljs-string">"Hello world"</span>)
        <span class="hljs-keyword">let</span> str = <span class="hljs-keyword">await</span> grid.downloadString(<span class="hljs-string">"MyFile.txt"</span>)
        assert.equal(str, <span class="hljs-string">"Hello world"</span>)

        <span class="hljs-comment">// Delete file</span>
        <span class="hljs-keyword">let</span> result = <span class="hljs-keyword">await</span> grid.deleteFile(<span class="hljs-string">"MyFile.txt"</span>)
        assert.ok(result, <span class="hljs-string">"Delete file failed"</span>)

        <span class="hljs-comment">// List files</span>
        <span class="hljs-keyword">await</span> grid.uploadString(<span class="hljs-string">"MyFile1.txt"</span>, <span class="hljs-string">"File 1"</span>)
        <span class="hljs-keyword">await</span> grid.uploadString(<span class="hljs-string">"MyFile2.txt"</span>, <span class="hljs-string">"File 2"</span>)
        <span class="hljs-keyword">let</span> files = <span class="hljs-keyword">await</span> grid.fileList(<span class="hljs-string">""</span>)
        assert.deepEqual(files, [<span class="hljs-string">"MyFile1.txt"</span>, <span class="hljs-string">"MyFile2.txt"</span>])
        <span class="hljs-keyword">await</span> grid.clear()

        <span class="hljs-comment">// Upload list of files</span>
        <span class="hljs-keyword">await</span> grid.uploadStrings({
            <span class="hljs-string">"dir/file.txt"</span>: <span class="hljs-string">"content 1"</span>,
            <span class="hljs-string">"dir/file2.txt"</span>: <span class="hljs-string">"content 2"</span>,
            <span class="hljs-string">"dir/subDir/file.txt"</span>: <span class="hljs-string">"content 3"</span>,
            <span class="hljs-string">"dir/subDir/file2.txt"</span>: <span class="hljs-string">"content 4"</span>,
        })
        files = <span class="hljs-keyword">await</span> grid.fileList(<span class="hljs-string">"dir"</span>)
        assert.deepEqual(files, [<span class="hljs-string">"dir/file.txt"</span>, <span class="hljs-string">"dir/file2.txt"</span>, <span class="hljs-string">"dir/subDir/file.txt"</span>, <span class="hljs-string">"dir/subDir/file2.txt"</span>])

        <span class="hljs-comment">// Download the files</span>
        str = <span class="hljs-keyword">await</span> grid.downloadString(<span class="hljs-string">"dir/subDir/file2.txt"</span>)
        assert.equal(str, <span class="hljs-string">"content 4"</span>)
        <span class="hljs-keyword">let</span> obj = <span class="hljs-keyword">await</span> grid.downloadStrings(<span class="hljs-string">"dir/subDir"</span>)
        assert.deepEqual(obj, {
            <span class="hljs-string">"dir/subDir/file.txt"</span>: <span class="hljs-string">"content 3"</span>,
            <span class="hljs-string">"dir/subDir/file2.txt"</span>: <span class="hljs-string">"content 4"</span>,
        })
        obj = <span class="hljs-keyword">await</span> grid.downloadStrings(<span class="hljs-string">"dir"</span>)
        assert.deepEqual(obj, {
            <span class="hljs-string">"dir/file.txt"</span>: <span class="hljs-string">"content 1"</span>,
            <span class="hljs-string">"dir/file2.txt"</span>: <span class="hljs-string">"content 2"</span>,
            <span class="hljs-string">"dir/subDir/file.txt"</span>: <span class="hljs-string">"content 3"</span>,
            <span class="hljs-string">"dir/subDir/file2.txt"</span>: <span class="hljs-string">"content 4"</span>,
        })
        <span class="hljs-keyword">await</span> grid.close()
    } <span class="hljs-keyword">catch</span> (e) {
        <span class="hljs-built_in">console</span>.log(e.message)
    }
}

test()
</code></pre>
				<h2 id="gridfs-file-operations">GridFS file operations</h2>
				<p>GridFS file operations transfers files directly to/from GridFS and a NodeJS compatible file system.</p>
				<h4 id="example">Example</h4>
				<pre><code class="lang-typescript"><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> assert <span class="hljs-keyword">from</span> <span class="hljs-string">"assert"</span>
<span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> dircompare <span class="hljs-keyword">from</span> <span class="hljs-string">"dir-compare"</span>
<span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> fs <span class="hljs-keyword">from</span> <span class="hljs-string">"fs"</span>
<span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> tmp <span class="hljs-keyword">from</span> <span class="hljs-string">"tmp"</span>
<span class="hljs-keyword">import</span> { GridFsFiles } <span class="hljs-keyword">from</span> <span class="hljs-string">"../../src/GridFsFiles"</span>

<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">test</span>(<span class="hljs-params"></span>) </span>{

    tmp.setGracefulCleanup() <span class="hljs-comment">// Clean temporary files afterwards</span>
    <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">let</span> grid = <span class="hljs-keyword">new</span> GridFsFiles()
        <span class="hljs-keyword">await</span> grid.open(<span class="hljs-string">"f"</span>)
        <span class="hljs-keyword">await</span> grid.clear()

        <span class="hljs-comment">// Check upload functionality</span>
        <span class="hljs-keyword">let</span> fileName = <span class="hljs-string">"examples/demo1/sound.mp3"</span>
        <span class="hljs-keyword">await</span> grid.uploadFile(fileName)
        assert.ok(<span class="hljs-keyword">await</span> grid.fileExists(fileName))
        assert.equal(<span class="hljs-keyword">await</span> grid.getFileSize(fileName), fs.statSync(fileName).size)
        <span class="hljs-keyword">await</span> grid.uploadFile(fileName, <span class="hljs-string">"dir1/dir2/dir3/file.mp3"</span>)
        assert.ok(<span class="hljs-keyword">await</span> grid.fileExists(<span class="hljs-string">"dir1/dir2/dir3/file.mp3"</span>))
        assert.equal(<span class="hljs-keyword">await</span> grid.getFileSize(<span class="hljs-string">"dir1/dir2/dir3/file.mp3"</span>), fs.statSync(fileName).size)

        <span class="hljs-comment">// Check download a single file</span>
        <span class="hljs-keyword">let</span> tempFile = tmp.tmpNameSync()
        <span class="hljs-keyword">let</span> result = <span class="hljs-keyword">await</span> grid.downloadFile(fileName, tempFile)
        assert.ok(result)
        <span class="hljs-keyword">let</span> original = fs.readFileSync(fileName);
        <span class="hljs-keyword">let</span> retrieved = fs.readFileSync(tempFile);
        assert.ok(original.equals(retrieved))

        <span class="hljs-comment">// Check upload and download folder, then compare files</span>
        result = <span class="hljs-keyword">await</span> grid.uploadFiles(<span class="hljs-string">"examples"</span>, <span class="hljs-string">"ex"</span>)
        <span class="hljs-keyword">let</span> tempFolder = tmp.dirSync().name
        result = <span class="hljs-keyword">await</span> grid.downloadFiles(<span class="hljs-string">"ex"</span>, tempFolder)
        <span class="hljs-keyword">let</span> options = { compareSize: <span class="hljs-literal">true</span>, compareContent: <span class="hljs-literal">true</span> };
        <span class="hljs-keyword">let</span> res = <span class="hljs-keyword">await</span> dircompare.compare(<span class="hljs-string">"examples"</span>, tempFolder + <span class="hljs-string">"/ex/examples"</span>, options);
        assert.ok(res.total &amp;&amp; res.equal === res.total)
        <span class="hljs-keyword">await</span> grid.close()
    } <span class="hljs-keyword">catch</span> (e) {
        <span class="hljs-built_in">console</span>.log(e.message)
    }
}

test()
</code></pre>
				<h2 id="objectid-and-json-rpc">ObjectID  and JSON RPC</h2>
				<p>The MongoDb class uses the standard ObjectID type as return value from insertDocument and in query objects (unless <em>_id</em> has been explicitly assigned with a value of another type when inserting documents). These objects can not normally be used as function arguments with JSON RPC. By setting the property useIdStrings (default false), hex strings representing the actual ObjectID stored in the database will be used for function return values and function arguments. The ID stored in the database will still be of type ObjectID.</p>
			</div>
		</div>
		<div class="col-4 col-menu menu-sticky-wrap menu-highlight">
			<nav class="tsd-navigation primary">
				<ul>
					<li class="globals  ">
						<a href="globals.html"><em>Globals</em></a>
					</li>
					<li class=" tsd-kind-external-module">
						<a href="modules/_gridfs_.html">"<wbr>Grid<wbr>Fs"</a>
					</li>
					<li class=" tsd-kind-external-module">
						<a href="modules/_gridfsfiles_.html">"<wbr>Grid<wbr>FsFiles"</a>
					</li>
					<li class=" tsd-kind-external-module">
						<a href="modules/_mongodbdatabase_.html">"<wbr>Mongo<wbr>DbDatabase"</a>
					</li>
					<li class=" tsd-kind-external-module">
						<a href="modules/_mongodbdatabases_.html">"<wbr>Mongo<wbr>DbDatabases"</a>
					</li>
				</ul>
			</nav>
			<nav class="tsd-navigation secondary menu-sticky">
				<ul class="before-current">
				</ul>
			</nav>
		</div>
	</div>
</div>
<footer class="with-border-bottom">
	<div class="container">
		<h2>Legend</h2>
		<div class="tsd-legend-group">
			<ul class="tsd-legend">
				<li class="tsd-kind-module"><span class="tsd-kind-icon">Module</span></li>
				<li class="tsd-kind-object-literal"><span class="tsd-kind-icon">Object literal</span></li>
				<li class="tsd-kind-variable"><span class="tsd-kind-icon">Variable</span></li>
				<li class="tsd-kind-function"><span class="tsd-kind-icon">Function</span></li>
				<li class="tsd-kind-function tsd-has-type-parameter"><span class="tsd-kind-icon">Function with type parameter</span></li>
				<li class="tsd-kind-index-signature"><span class="tsd-kind-icon">Index signature</span></li>
				<li class="tsd-kind-type-alias"><span class="tsd-kind-icon">Type alias</span></li>
			</ul>
			<ul class="tsd-legend">
				<li class="tsd-kind-enum"><span class="tsd-kind-icon">Enumeration</span></li>
				<li class="tsd-kind-enum-member"><span class="tsd-kind-icon">Enumeration member</span></li>
				<li class="tsd-kind-property tsd-parent-kind-enum"><span class="tsd-kind-icon">Property</span></li>
				<li class="tsd-kind-method tsd-parent-kind-enum"><span class="tsd-kind-icon">Method</span></li>
			</ul>
			<ul class="tsd-legend">
				<li class="tsd-kind-interface"><span class="tsd-kind-icon">Interface</span></li>
				<li class="tsd-kind-interface tsd-has-type-parameter"><span class="tsd-kind-icon">Interface with type parameter</span></li>
				<li class="tsd-kind-constructor tsd-parent-kind-interface"><span class="tsd-kind-icon">Constructor</span></li>
				<li class="tsd-kind-property tsd-parent-kind-interface"><span class="tsd-kind-icon">Property</span></li>
				<li class="tsd-kind-method tsd-parent-kind-interface"><span class="tsd-kind-icon">Method</span></li>
				<li class="tsd-kind-index-signature tsd-parent-kind-interface"><span class="tsd-kind-icon">Index signature</span></li>
			</ul>
			<ul class="tsd-legend">
				<li class="tsd-kind-class"><span class="tsd-kind-icon">Class</span></li>
				<li class="tsd-kind-class tsd-has-type-parameter"><span class="tsd-kind-icon">Class with type parameter</span></li>
				<li class="tsd-kind-constructor tsd-parent-kind-class"><span class="tsd-kind-icon">Constructor</span></li>
				<li class="tsd-kind-property tsd-parent-kind-class"><span class="tsd-kind-icon">Property</span></li>
				<li class="tsd-kind-method tsd-parent-kind-class"><span class="tsd-kind-icon">Method</span></li>
				<li class="tsd-kind-accessor tsd-parent-kind-class"><span class="tsd-kind-icon">Accessor</span></li>
				<li class="tsd-kind-index-signature tsd-parent-kind-class"><span class="tsd-kind-icon">Index signature</span></li>
			</ul>
			<ul class="tsd-legend">
				<li class="tsd-kind-constructor tsd-parent-kind-class tsd-is-inherited"><span class="tsd-kind-icon">Inherited constructor</span></li>
				<li class="tsd-kind-property tsd-parent-kind-class tsd-is-inherited"><span class="tsd-kind-icon">Inherited property</span></li>
				<li class="tsd-kind-method tsd-parent-kind-class tsd-is-inherited"><span class="tsd-kind-icon">Inherited method</span></li>
				<li class="tsd-kind-accessor tsd-parent-kind-class tsd-is-inherited"><span class="tsd-kind-icon">Inherited accessor</span></li>
			</ul>
			<ul class="tsd-legend">
				<li class="tsd-kind-property tsd-parent-kind-class tsd-is-protected"><span class="tsd-kind-icon">Protected property</span></li>
				<li class="tsd-kind-method tsd-parent-kind-class tsd-is-protected"><span class="tsd-kind-icon">Protected method</span></li>
				<li class="tsd-kind-accessor tsd-parent-kind-class tsd-is-protected"><span class="tsd-kind-icon">Protected accessor</span></li>
			</ul>
			<ul class="tsd-legend">
				<li class="tsd-kind-property tsd-parent-kind-class tsd-is-private"><span class="tsd-kind-icon">Private property</span></li>
				<li class="tsd-kind-method tsd-parent-kind-class tsd-is-private"><span class="tsd-kind-icon">Private method</span></li>
				<li class="tsd-kind-accessor tsd-parent-kind-class tsd-is-private"><span class="tsd-kind-icon">Private accessor</span></li>
			</ul>
			<ul class="tsd-legend">
				<li class="tsd-kind-property tsd-parent-kind-class tsd-is-static"><span class="tsd-kind-icon">Static property</span></li>
				<li class="tsd-kind-call-signature tsd-parent-kind-class tsd-is-static"><span class="tsd-kind-icon">Static method</span></li>
			</ul>
		</div>
	</div>
</footer>
<div class="container tsd-generator">
	<p>Generated using <a href="http://typedoc.org/" target="_blank">TypeDoc</a></p>
</div>
<div class="overlay"></div>
<script src="assets/js/main.js"></script>
<script>if (location.protocol == 'file:') document.write('<script src="assets/js/search.js"><' + '/script>');</script>
</body>
</html>